<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaroku Care - Healthflo Consent Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Serif:wght@400;600;700&family=Noto+Sans+Tamil:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #0f172a; /* Slate 900 */
            --accent: #312e81; /* Indigo 900 */
            --highlight: #0891b2; /* Cyan 600 */
            --light-bg: #eff6ff; /* Blue 50 */
            --border: #cbd5e1;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #525252;
            -webkit-print-color-adjust: exact;
            /* Center the content */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .serif-font { font-family: 'Noto Serif', serif; }
        .tamil-text { font-family: 'Noto Sans Tamil', sans-serif; }

        /* Professional Input Styling - Compact */
        input[type="text"], input[type="number"], input[type="date"], input[type="tel"] {
            background: transparent;
            border: none;
            border-bottom: 1.5px solid #94a3b8;
            width: 100%;
            padding: 0 2px;
            font-size: 0.8rem;
            color: #1e293b;
            font-weight: 600;
            outline: none;
            border-radius: 0;
            height: 1.25rem;
            transition: all 0.2s;
        }
        
        input:focus { 
            border-bottom: 2px solid var(--highlight); 
            background-color: rgba(8, 145, 178, 0.05); 
        }
        input::placeholder { color: #cbd5e1; font-weight: 400; font-size: 0.7rem; }

        /* Custom Checkbox */
        .custom-checkbox {
            appearance: none;
            width: 0.9rem;
            height: 0.9rem;
            border: 1.5px solid #475569;
            border-radius: 3px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.4rem;
            position: relative;
            cursor: pointer;
            background-color: white;
            transition: all 0.2s;
        }
        
        .custom-checkbox:checked {
            background-color: var(--highlight);
            border-color: var(--highlight);
        }
        
        .custom-checkbox:checked::after {
            content: '✓';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.6rem;
            font-weight: bold;
        }

        /* Bilingual Label Compact */
        .bilingual-label { display: flex; flex-direction: column; line-height: 1; margin-bottom: 1px; }
        .bilingual-label .en { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #334155; letter-spacing: 0.02em; }
        .bilingual-label .ta { font-size: 0.6rem; color: #64748b; font-weight: 500; margin-top: 1px; }

        /* Page Container - Locked to A4 */
        .page-container {
            width: 210mm;
            height: 296mm; /* A4 Height */
            background: white;
            margin: 0 auto;
            position: relative;
            box-sizing: border-box;
            padding: 8mm 12mm; /* Tighter margins to fit content */
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        .section-header {
            display: flex;
            align-items: center;
            border-left: 5px solid var(--highlight);
            padding-left: 8px;
            margin-bottom: 4px; /* Reduced margin */
            background: linear-gradient(to right, #f0f9ff, transparent);
            padding-top: 2px;
            padding-bottom: 2px;
            border-radius: 0 4px 4px 0;
        }

        @media print {
            body { background: none; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .page-container {
                box-shadow: none;
                margin: 0;
                width: 100%;
                height: 100%;
                page-break-after: avoid;
                page-break-before: avoid;
            }
            @page {
                size: A4;
                margin: 0; 
            }
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
        }

        /* Styling for the copy-ready ID field */
        #documentIdContainer {
            margin-left: 1rem;
            display: none; /* Hide until saved */
            align-items: center;
            background: #475569;
            border-radius: 4px;
            padding: 0 0.5rem;
        }
        #documentIdDisplay {
            background: none;
            border: none;
            color: #fff;
            font-size: 12px;
            font-family: monospace;
            padding: 4px 0;
            width: 120px;
        }
    </style>
</head>
<body class="flex justify-center items-start min-h-screen py-6">

    <!-- Cloud Control Panel (No Print) -->
    <div class="fixed top-0 left-0 w-full bg-slate-800 text-white p-3 no-print z-50 shadow-md flex justify-between items-center px-8">
        <div class="flex items-center gap-3">
            <span class="font-bold text-sm tracking-wide text-cyan-400">AAROKU CLOUD FORM</span>
            <span id="saveStatus" class="text-xs text-gray-400 italic">Unsaved</span>
        </div>
        
        <!-- Document ID and Copy -->
        <div class="flex items-center">
            <div id="documentIdContainer">
                <span class="text-gray-300 text-xs font-semibold mr-2">ID:</span>
                <input type="text" id="documentIdDisplay" value="" readonly>
                <button onclick="copyDocumentId()" class="bg-indigo-600 hover:bg-indigo-700 p-1 rounded ml-2">
                     <i data-lucide="copy" class="w-3 h-3 text-white"></i>
                </button>
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="saveFormData()" class="flex items-center gap-2 bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-1.5 rounded text-sm font-semibold transition-all">
                <i data-lucide="link" class="w-4 h-4"></i> Save & Get Link
            </button>
            <button onclick="window.print()" class="flex items-center gap-2 bg-white hover:bg-gray-100 text-slate-900 px-4 py-1.5 rounded text-sm font-semibold transition-all">
                <i data-lucide="printer" class="w-4 h-4"></i> Print PDF
            </button>
        </div>
    </div>
    
    <!-- Spacer for fixed header -->
    <div class="h-16 w-full no-print"></div>

    <!-- A4 Container -->
    <div class="page-container shadow-2xl border-t-[8px] border-indigo-900">
        
        <!-- Header -->
        <header class="flex justify-between items-center border-b border-slate-200 pb-2 mb-2">
            <div class="flex items-center gap-4">
                <!-- Logo Zone: Hardcoded with Fallback -->
                <div class="w-20 h-20 flex items-center justify-center bg-white rounded-lg overflow-hidden relative">
                    <img src="https://raw.githubusercontent.com/HEALTHFO/aaroku-care/main/logo.png" 
                         class="w-full h-full object-contain" 
                         alt="Aaroku Care Logo"
                         onerror="
                            if (this.getAttribute('data-has-error')) {
                                this.style.display='none'; 
                                document.getElementById('logoFallback').style.display='flex';
                            } else {
                                this.setAttribute('data-has-error', 'true');
                                this.src = 'https://placehold.co/200x200?text=Aaroku'; 
                            }
                         ">
                    <div id="logoFallback" class="hidden absolute inset-0 text-center border border-dashed border-gray-300 w-full h-full items-center justify-center rounded bg-gray-50">
                         <span class="text-[0.5rem] font-bold text-gray-400">LOGO</span>
                    </div>
                </div>
                
                <div>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight leading-none">AAROKU CARE</h1>
                    <div class="flex flex-col mt-1">
                        <span class="text-cyan-700 text-[0.65rem] font-bold uppercase tracking-widest">Healthflo Division</span>
                        <span class="text-slate-500 tamil-text text-[0.65rem] font-medium">ஹெல்த்ஃப்ளோ பிரிவு</span>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <h2 class="text-sm font-bold text-slate-800 uppercase tracking-wide">Financial Consent Form</h2>
                <p class="text-[0.65rem] text-slate-500 tamil-text font-medium">நிதிக் கட்டண ஒப்புதல் படிவம்</p>
                <div class="mt-2 flex justify-end items-center gap-2">
                    <span class="text-[0.7rem] font-bold text-slate-600">DATE / தேதி:</span>
                    <input type="text" id="date" placeholder="DD / MM / YYYY" class="w-24 text-center border-b border-slate-300 text-sm font-mono bg-slate-50">
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-col flex-grow gap-2"> <!-- Reduced gap -->

            <!-- Hospital Name -->
            <div class="flex items-end gap-3 bg-slate-50 p-2 rounded-md border border-slate-200 shadow-sm">
                <div class="bilingual-label w-32 flex-shrink-0">
                    <span class="en text-slate-800">Hospital Name</span>
                    <span class="ta">மருத்துவமனை பெயர்</span>
                </div>
                <input type="text" id="hospitalName" class="font-bold text-base text-slate-900 bg-transparent !border-b-2 !border-slate-300" placeholder="">
            </div>

            <!-- Section I: Patient -->
            <section>
                <div class="section-header">
                    <div class="flex flex-col leading-none">
                        <span class="text-[0.75rem] font-bold text-slate-800 uppercase tracking-wide">I. Patient Details</span>
                        <span class="text-[0.55rem] text-slate-500 tamil-text mt-0.5">நோயாளி விவரங்கள்</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-12 gap-x-5 gap-y-1.5 px-2"> <!-- Reduced gap-y -->
                    <div class="col-span-6">
                        <div class="bilingual-label"><span class="en">Patient Name</span><span class="ta">நோயாளி பெயர்</span></div>
                        <input type="text" id="patientName">
                    </div>
                    <div class="col-span-2">
                        <div class="bilingual-label"><span class="en">Age</span><span class="ta">வயது</span></div>
                        <input type="number" id="age">
                    </div>
                    <div class="col-span-2">
                        <div class="bilingual-label"><span class="en">Gender</span><span class="ta">பாலினம்</span></div>
                        <input type="text" id="gender" placeholder="M/F">
                    </div>
                    <div class="col-span-2">
                        <div class="bilingual-label"><span class="en">Mobile No.</span><span class="ta">கைபேசி எண்</span></div>
                        <input type="tel" id="patientMobile">
                    </div>

                    <div class="col-span-6">
                        <div class="bilingual-label"><span class="en">Patient Aadhaar No.</span><span class="ta">நோயாளி ஆதார் எண்</span></div>
                        <input type="text" id="patientAadhaar" class="tracking-widest">
                    </div>
                    <div class="col-span-6">
                        <div class="bilingual-label"><span class="en">Insured Aadhaar No.</span><span class="ta">காப்பீட்டாளர் ஆதார் எண்</span></div>
                        <input type="text" id="insuredAadhaar" class="tracking-widest">
                    </div>
                </div>
            </section>

            <!-- Section II: Borrower -->
            <section>
                <div class="section-header">
                    <div class="flex flex-col leading-none">
                        <span class="text-[0.75rem] font-bold text-slate-800 uppercase tracking-wide">II. Borrower Details</span>
                        <span class="text-[0.55rem] text-slate-500 tamil-text mt-0.5">வாடிக்கையாளர் விவரங்கள்</span>
                    </div>
                </div>

                <div class="grid grid-cols-12 gap-x-5 gap-y-1.5 px-2"> <!-- Reduced gap-y -->
                    <div class="col-span-6">
                        <div class="bilingual-label"><span class="en">Borrower Name (Vadikaiyalar)</span><span class="ta">வாடிக்கையாளர் பெயர்</span></div>
                        <input type="text" id="borrowerName">
                    </div>
                    <div class="col-span-6">
                        <div class="bilingual-label"><span class="en">Borrower Mobile No.</span><span class="ta">வாடிக்கையாளர் கைபேசி எண்</span></div>
                        <input type="tel" id="borrowerMobile">
                    </div>
                    <div class="col-span-12">
                        <div class="bilingual-label"><span class="en">Bank Name</span><span class="ta">வங்கி பெயர்</span></div>
                        <input type="text" id="bankName">
                    </div>
                </div>
            </section>

            <!-- Section III: Payment -->
            <section>
                <div class="section-header !border-cyan-600 !bg-cyan-50/50">
                    <div class="flex flex-col leading-none">
                        <span class="text-[0.75rem] font-bold text-cyan-900 uppercase tracking-wide">III. Security & Repayment Instrument</span>
                        <span class="text-[0.55rem] text-cyan-700 tamil-text mt-0.5">பாதுகாப்பு & திருப்பிச் செலுத்துதல் விவரங்கள்</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-8 px-4 mt-1"> <!-- Reduced margin -->
                    <!-- NACH -->
                    <div class="border-r border-slate-200 pr-6">
                        <label class="flex items-center cursor-pointer mb-2 group">
                            <input type="checkbox" id="nachCheckbox" class="custom-checkbox"> 
                            <span class="text-xs font-bold text-slate-800 ml-2 group-hover:text-cyan-700 transition-colors">NACH Mandate</span>
                        </label>
                        <div class="pl-6">
                            <div class="bilingual-label"><span class="en">NACH Max Amount (₹)</span><span class="ta">நாச் தொகை</span></div>
                            <input type="text" id="nachAmount" placeholder="₹ 0.00" class="font-mono text-base bg-white/50 px-1 border-slate-300">
                        </div>
                    </div>

                    <!-- Cheque -->
                    <div>
                        <label class="flex items-center cursor-pointer mb-2 group">
                            <input type="checkbox" id="chequeCheckbox" class="custom-checkbox"> 
                            <div class="flex flex-col ml-2 leading-none">
                                <span class="text-xs font-bold text-slate-800 group-hover:text-cyan-700 transition-colors">Security Cheque</span>
                                <span class="text-[0.55rem] text-slate-500 tamil-text mt-0.5">பாதுகாப்பு காசோலை</span>
                            </div>
                        </label>
                        <div class="pl-6 grid grid-cols-2 gap-4">
                            <div>
                                <div class="bilingual-label"><span class="en">Amount (₹)</span><span class="ta">தொகை</span></div>
                                <input type="text" id="chequeAmount" placeholder="₹ 0.00" class="font-mono text-base bg-white/50 px-1 border-slate-300">
                            </div>
                            <div>
                                <div class="bilingual-label"><span class="en">Cheque No (Last 4)</span><span class="ta">காசோலை எண்</span></div>
                                <input type="text" id="chequeNumber" placeholder="XXXX" class="font-mono text-center text-base bg-white/50 px-1 border-slate-300" maxlength="4">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Legal Declaration -->
            <section class="mt-1">
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-2.5">
                    <div class="flex items-center gap-2 mb-1 border-b border-slate-300 pb-1">
                        <i data-lucide="scale" class="w-4 h-4 text-slate-700"></i>
                        <strong class="text-slate-900 uppercase tracking-wide text-[0.65rem]">Declaration of Liability / உறுதிமொழி</strong>
                    </div>
                    <ol class="list-decimal pl-4 space-y-1">
                        <!-- Clause 1: Conditional Liability -->
                        <li class="pl-2">
                            <p class="text-[0.6rem] leading-tight text-slate-800 text-justify serif-font">
                                <strong class="text-black">Conditional Liability:</strong> I acknowledge that I am liable to pay the hospital bill <span class="underline decoration-slate-400 decoration-1">ONLY IF</span> the health insurance claim is <strong>REJECTED</strong> or <strong>DELAYED beyond 60 days</strong>.
                            </p>
                            <p class="text-[0.55rem] text-slate-500 tamil-text mt-0.5 leading-tight">
                                மருத்துவ காப்பீட்டு கோரிக்கை நிராகரிக்கப்பட்டாலோ அல்லது 60 நாட்களுக்கு மேல் தாமதமானாலோ மட்டுமே மருத்துவமனை கட்டணத்தை செலுத்த நான் கடமைப்பட்டுள்ளேன்.
                            </p>
                        </li>
                        
                        <!-- Clause 2: Notification & Repayment -->
                        <li class="pl-2">
                            <p class="text-[0.6rem] leading-tight text-slate-800 text-justify serif-font">
                                <strong class="text-black">Notification & Repayment:</strong> I agree to intimate the Hospital within <strong>24 hours</strong> of receiving any insurance settlement. I undertake to settle the hospital dues within <strong>60 days</strong> from discharge. <span class="italic font-semibold">However</span>, if the insurance claim is settled earlier, I agree to transfer the amount to the Hospital within <strong>48 hours</strong> of such settlement.
                            </p>
                            <p class="text-[0.55rem] text-slate-500 tamil-text mt-0.5 leading-tight">
                                காப்பீட்டுத் தொகை கிடைத்த 24 மணி நேரத்திற்குள் மருத்துவமனைக்கு தகவல் தெரிவிக்கிறேன். டிஸ்சார்ஜ் செய்யப்பட்ட 60 நாட்களுக்குள் கட்டணத்தை செலுத்த வேண்டும். இருப்பினும், காப்பீட்டுத் தொகை அதற்கு முன்பே கிடைத்தால், கிடைத்த 48 மணி நேரத்திற்குள் அத்தொகையை மருத்துவமனைக்கு செலுத்த உறுதியளிக்கிறேன்.
                            </p>
                        </li>

                        <!-- Clause 3: Breach of Trust -->
                        <li class="pl-2">
                            <p class="text-[0.6rem] leading-tight text-slate-800 text-justify serif-font">
                                If funds are settled to the Policy Holder, failure to transfer the amount within the stipulated time (48 hours) constitutes a serious <strong>breach of trust and contract</strong>, authorizing the Hospital/Aaroku Care to initiate recovery proceedings using the Security Instrument.
                            </p>
                            <p class="text-[0.55rem] text-slate-500 tamil-text mt-0.5 leading-tight">
                                காப்பீட்டுப் பணம் பாலிசிதாரருக்கு கிடைத்து, அதை 48 மணி நேரத்திற்குள் மருத்துவமனைக்கு மாற்றத் தவறினால், அது நம்பிக்கை மீறலாகக் கருதப்படும் மற்றும் சட்டப்பூர்வ நடவடிக்கைக்கு வழிவகுக்கும்.
                            </p>
                        </li>
                    </ol>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <footer class="mt-auto pt-2 border-t-2 border-slate-800">
            <div class="flex justify-between items-end">
                <div class="text-center w-1/3">
                    <div class="h-10"></div>
                    <div class="border-t border-slate-900 pt-1">
                        <div class="text-[0.65rem] font-bold text-slate-900 uppercase">Signature of Borrower</div>
                        <div class="text-[0.55rem] text-slate-500 tamil-text">வாடிக்கையாளர் கையப்பம்</div>
                    </div>
                </div>
                
                <div class="text-center w-1/3">
                    <div class="h-10"></div>
                    <div class="border-t border-slate-900 pt-1">
                        <div class="text-[0.65rem] font-bold text-slate-900 uppercase">Hospital Representative</div>
                        <div class="text-[0.55rem] text-slate-500 tamil-text">மருத்துவமனை பிரதிநிதி</div>
                        <div class="text-[0.55rem] text-slate-400 mt-0.5">(Sign & Seal)</div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-2 flex items-center justify-center gap-1.5 opacity-60">
                <i data-lucide="lock" class="w-3 h-3 text-slate-500"></i>
                <span class="text-[0.5rem] text-slate-500 uppercase tracking-widest font-semibold">Confidential Financial Document | Aaroku Care</span>
            </div>
        </footer>

    </div>

    <div id="toast">Link copied to clipboard!</div>

    <script>
        lucide.createIcons();

        // 1. Init Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let currentDocId = null;

        // Geolocation variables
        let userLatitude = null;
        let userLongitude = null;

        // Function to get user's location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLatitude = position.coords.latitude;
                        userLongitude = position.coords.longitude;
                        console.log(`Location captured: Lat=${userLatitude}, Lon=${userLongitude}`);
                    },
                    (error) => {
                        console.warn('Geolocation failed:', error.message);
                        userLatitude = 'Denied/Unavailable';
                        userLongitude = 'Denied/Unavailable';
                    }, 
                    {
                        enableHighAccuracy: false,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                console.warn("Geolocation not supported by this browser.");
                userLatitude = 'Not Supported';
                userLongitude = 'Not Supported';
            }
        }


        // 2. Auth & Load
        async function init() {
            // Start location tracking immediately
            getCurrentLocation();
            
            try {
                // Auth check
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        // Check URL params
                        const urlParams = new URLSearchParams(window.location.search);
                        const docId = urlParams.get('id');
                        if (docId) {
                            currentDocId = docId;
                            await loadFormData(docId);
                            // Show ID on load
                            document.getElementById('documentIdDisplay').value = docId;
                            document.getElementById('documentIdContainer').style.display = 'flex';
                        }
                    }
                });
            } catch (error) {
                console.error("Auth failed:", error);
            }
        }

        // 3. Save Data
        async function saveFormData() {
            if (!currentUser) return;

            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = 'Saving...';

            const data = {};
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    data[input.id] = input.checked;
                } else {
                    data[input.id] = input.value;
                }
            });

            // Add geolocation data to the log
            data.log = {
                location: {
                    latitude: userLatitude,
                    longitude: userLongitude,
                    timestamp: new Date().toISOString()
                },
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (currentDocId) {
                    // Update existing
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('forms').doc(currentDocId).update(data);
                } else {
                    // Create new
                    const docRef = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('forms').add(data);
                    currentDocId = docRef.id;
                }

                statusEl.textContent = 'Saved!';
                
                // Update URL and ID display
                const newUrl = `${window.location.pathname}?id=${currentDocId}`;
                window.history.pushState({path: newUrl}, '', newUrl);
                
                document.getElementById('documentIdDisplay').value = currentDocId;
                document.getElementById('documentIdContainer').style.display = 'flex';


                // Copy to clipboard
                const fullUrl = window.location.href;
                
                const textArea = document.createElement("textarea");
                textArea.value = fullUrl;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                   document.execCommand('copy');
                   showToast("Form Saved! Link copied to clipboard.");
                } catch (err) {
                   showToast("Form Saved! Copy the URL to share.");
                }
                document.body.removeChild(textArea);

            } catch (error) {
                console.error("Save error:", error);
                statusEl.textContent = 'Error Saving';
                showToast("Error saving form. Check permissions.");
            }
        }

        // 4. Load Data
        async function loadFormData(id) {
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = 'Loading...';
            
            try {
                const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('forms').doc(id);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    const data = docSnap.data();
                    const inputs = document.querySelectorAll('input');
                    
                    inputs.forEach(input => {
                        if (data.hasOwnProperty(input.id)) {
                             if (input.type === 'checkbox') {
                                input.checked = data[input.id];
                            } else {
                                input.value = data[input.id];
                            }
                        }
                    });
                    statusEl.textContent = 'Loaded';
                } else {
                    statusEl.textContent = 'Not Found';
                    showToast("Form ID not found.");
                }
            } catch (error) {
                console.error("Load error:", error);
                statusEl.textContent = 'Error Loading';
            }
        }
        
        // 5. Copy ID function
        function copyDocumentId() {
            const idField = document.getElementById('documentIdDisplay');
            if (idField.value) {
                idField.select();
                try {
                    document.execCommand('copy');
                    showToast("Document ID copied!");
                } catch (err) {
                    showToast("Failed to copy ID.");
                }
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // Run
        init();
    </script>
</body>
</html>
